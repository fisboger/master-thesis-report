\documentclass{report}
\usepackage{import}
\subimport{../../}{preamble.tex}
\standalonetrue
\begin{document}

% sample content
\section{CVE-2021-24086}
\label{sec:CVE-2021-24086}
According to Microsoft\cite{url:microsoft:cve-2021-24086} CVE-2021-24086 is a denial of service vulnerability with a CVSS:3.0 score of 7.5 / 6.5, that is a base score metrics of 7.5 and a temporal score metrics of 6.5. The vulnerability affects all supported versions of Windows and Windows Server. According to an accompanied blog post published by Microsoft
\cite{url:microsoft:cve-2021-24086-blog} at the same time as the patch was released, details that the vulnerable component is the Windows TCP/IP implementation, and that the vulnerability revolves around IPv6 fragmentation. The Security Update guide and the blog post also \todo{Figure out if this should be here}present a workaround that can be used to temporarily mitigate the vulnerability by disabling IPv6 fragmentation.

\subsection{Public information}
\label{sec:CVE-2021-24086:public-information}
Due to the \gls{mapp}\cite{url:microsoft:mapp} security software providers are given early access to vulnerability information. This information often include \gls{poc}s for vulnerabilities to be patched, in order to aid security software providers to create valid detections for exploitation of soon-to-be patched vulnerabilities. Due to \gls{mapp}, some security software providers publish relevant information regarding recently patched vulnerabilities. However, the information is usually very vague in details, and can therefore only aid in the initial exploration of the vulnerability. For CVE-2021-24086, both McAfee\cite{url:mcafee:cve-2021-24086} and Palo Alto\cite{url:palo-alto:cve-2021-24086} posted public information about CVE-2021-24086. However, both articles contained very limited details, and is therefore far from sufficient to reproduce the vulnerability. Before trying to rediscover the vulnerability, the following information is available:

\begin{itemize}
    \item The vulnerability lies within the handling om fragmented packets in IPv6
    \item The relevant code lies within the \mintinline{c}{tcpip.sys} drivers
    \item The root cause of the vulnerability is a NULL pointer dereference in \mintinline{c}{Ipv6ReassembleDatagram} of \mintinline{c}{tcpip.sys}
    \item The reassembled packet should contain around 0xFFFF (65535) bytes of extension headers, which is usually not possible
\end{itemize}
 
\subsection{Binary diffing}
The usage of binary diffing to gather information about patched vulnerabilities is well described in current research\cite{url:binary-diffing:1}\cite{url:binary-diffing:2}, and has been made popular and easy to do by tools such as Bindiff\cite{url:bindiff:homepage} and Diaphora\cite{url:diaphora:homepage}. \todo{write a little about how bindiffing works. Or don't idc.}
\\
\\
If we look at figure \ref{fig:tcpipsys-bindiff-primary-matched} we can compare the function changes of the patched and not-patched \mintinline{c}{tcpip.sys}. Looking at \mintinline{c}{tcpip!Ipv6pReassembleDatagram} we can see that the similarity factor is only 0.38 telling us that a significant amount of code has been changed.

\subimport{figures/}{tcpipsys-bindiff-primary-matched.tex}

Diving into the binary diff of \mintinline{c}{tcpip!Ipv6pReassembleDatagram} as seen on listing \ref{listing:diff:Ipv6pReassembleDatagram}, we can clearly see a change. The first many changes from line \emph{5-39} are simply register changes and other insignificant changes due to how the compiler works. However, on line \emph{41-42} a new comparison is made to ensure that the value of the register \mintinline{c}{edx} is less than 0xFFFF. This matches the statement given in \fullref{sec:CVE-2021-24086:public-information}, that the vulnerability is triggered by a package of around 0xFFFF bytes.

\subimport{figures/}{diff-Ipv6pReassembleDatagram.tex}

Looking at the raw assembly without any knowledge of what the registers contain or what parameters are passed to the function can be very confusing. To make it easier for the reader to follow, listing \ref{listing:diff:Ipv6pReassembleDatagram-c} contains the annotated decompiled code of the vulnerable and patched \mintinline{c}{tcpip!Ipv6pReassembleDatagram} function. Here the patch is easy to spot, as the call to \mintinline{c}{tcpip!NetioAllocateAndReferenceNetBufferAndNetBufferList} is replaced with the check that we also observed in listing \ref{listing:diff:Ipv6pReassembleDatagram}. The check is there to ensure that the total packet size is less than 0xFFFF, which is the largest 16 bit value. The packet size is calculated on line \emph{4-6} using the fragmentable and unfragmentable parts of the reassembled packet.

\subimport{figures/}{diff-Ipv6pReassembleDatagram-c.tex}

At this stage of the vulnerability rediscovery process, the following requirements are now available:
\begin{itemize}
    \item We have to abuse IPv6 fragmentation in \mintinline{c}{tcpip!Ipv6pReassembleDatagram}
    \item We have to construct a single packet with around 0xFFFF bytes of extension headers
    \item We have to trigger a null dereference somewhere in \mintinline{c}{tcpip!Ipv6pReassembleDatagram}
\end{itemize}

The next section will give a primer into how IPv6 fragmentation works to better understand how we can fulfill the above-mentioned requirements.

\subsection{IPv6 fragmentation primer}
\subsubsection{IPv6 Extension headers}
\cite[sec. 4.5]{url:rfc:ipv6}
\subimport{figures/}{ipv6-fragmentation.tex}
\subimport{figures/}{ipv6-fragment-header.tex}

\subsubsection{IPv6 Fragment header}



\subsection{Root-cause analysis}

\subsection{Triggering the vulnerability}

% \subimport{}{subsubsection.tex}

\end{document}